<!DOCTYPE html>
<html lang="{{ lang }}">
<head>
    <title>Recomendador de Caf√©</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css">

    
    <link href="https://fonts.googleapis.com/css2?family=Trocchi&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">

    <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
</head>
<body>
    <header>
        <a class="logo" href="{{ url_for('index') }}">PARTDO COFFE</a>

        <ul class="ul_contador">

            <li class="iniciar-sesion">
                <i class="bi bi-person-circle icono-nav"></i>
                {% if session.get('usuario') %}
                    <!-- Hola, {{ session.get('usuario') }} -->
                    {{ textos.hola }}, {{ session.get('usuario') }}
                {% else %}
                    <!-- Hola, Inicia sesi√≥n -->
                    {{ textos.inicia_sesion }}
                {% endif %}

                <ul class="ul-segundo">
                    {% if session.get('usuario') %}
                    <li><a href="{{ url_for('logout') }}">{{ textos.cerrar_sesion }}</a></li>
                    {% else %}
                    <li><a href="{{ url_for('login') }}">{{ textos.iniciar_sesion }}</a></li>
                    {% endif %}
                </ul>
            </li>

            {% if session.get('rol') == 'admin' %}
            <li><a class="icono" href="{{ url_for('resultados') }}"><i class="bi bi-bar-chart-line icono-nav"></i> {{ textos.resultados }}</a></li>
            {% endif %}

        </ul>
    </header>
    
    <h1 class="titulo">‚òï {{ textos.titulo }}</h1>

    <!-- Idioma -->
    <form class="mb-3 d-flex justify-content-between align-items-center Opciones">
        <div>
            
            <button id="btnLeer" type="button" class="btn btn-secondary" onclick="leerFrases()">üîä {{ textos.leer }}</button>
            <button type="button" class="btn btn-outline-dark" onclick="reconocer()">üéôÔ∏è {{ textos.voz }}</button>
        </div>
        <div>
            <img src="{{ url_for('static', filename='images/Logo_Partdo.png') }}" 
            alt="Decoraci√≥n" 
            style="width: 70px;">
        </div>
        <div>
            <label for="lang" class="me-2">üåê {{ 'Idioma' if lang == 'es' else 'Linguagem' if lang == 'br' else 'Language' }}:</label>
            <select name="lang" onchange="this.form.submit()">
                <option value="es" {% if lang == 'es' %}selected{% endif %}>Espa√±ol</option>
                <option value="en" {% if lang == 'en' %}selected{% endif %}>English</option>
                <option value="br" {% if lang == 'br' %}selected{% endif %}>Portugu√™s (BR)</option>
            </select>
        </div>
    </form>

    <img src="{{ url_for('static', filename='images/Logo_Partdo.png') }}" 
        alt="Decoraci√≥n" 
        style="position: fixed; bottom: 20px; right: 20px; width: 80px; z-index: 999; pointer-events: none;">

        <form method="POST" class="mt-4" id="formulario" action="/?lang={{ lang }}">

            <input type="text" name="nombre" id="nombre" class="form-control" placeholder="{{ textos.placeholder }}" required autocomplete="off"><br>

            <div id="perfil_sabor_group" style="display: none;">

                <label for="perfil">{{ textos.sabor_label }}</label>
                <select name="perfil" id="perfil" class="form-select" multiple>

                    {% for sabor in textos.sabores %}
                        <option value="{{ sabor | lower }}">{{ sabor }}</option>
                    {% endfor %}
                </select>
            </div>
            
            <button type="submit" class="btn btn-light">{{ textos.boton }}</button>

        </form>
        
        <br>
        
        <form method="get" action="{{ url_for('encuesta') }}">
            <button type="submit" class="btn btn-light">{{ textos.encuesta }}</button>
        </form>


    <hr>

    <h3 class="text-center alert alert-warning">ü§ñ {{ textos.asistente }}</h3>

    <div class="chat-box border rounded p-3 mb-3 m-auto" id="chatBox" style="height: 250px; overflow-y: auto; background-color: #f0f0f0;">
        <p><strong>{{ textos.chat_emisor }}: </strong>{{ textos.chat_respuesta }} </p>
    </div>

    <button id="btnHablar" class="btn btn-dark" onclick="toggleGrabacion()">
        üéôÔ∏è Hablar
    </button>

    <button id="btnVoz" class="btn btn-secondary" onclick="toggleVoz()">
        üîä Activar voz
    </button>

    <div id="sabores-container">
        {% if sabores_seleccionados %}
            <div class="alert alert-warning text-center mt-4">
                <strong>‚ú® {{ textos.seleccion }} üòã</strong><br>
                {% for s in sabores_seleccionados %}
                    ‚òï {{ s }}{% if not loop.last %}, {% endif %}
                {% endfor %}
            </div>
        {% endif %}
    </div>

        
    <div id="recomendaciones-container">
        {% if recomendaciones %}
            <h3 class="text-black text-center mt-4">‚ú® {{ textos.recomendaciones }}</h3>
            <div class="d-flex justify-content-center flex-wrap gap-4 mt-4">
                {% for rec in recomendaciones %}
                    <div class="col-md-4 producto">
                        <h5>{{ rec }}</h5>
                        <img src="{{ url_for('static', filename='images/' + nombre_a_imagen.get(rec, 'default.jpg')) }}"
                            class="img-fluid rounded"
                            onerror="this.onerror=null;this.src='/static/images/default.jpg';">
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    </div>


    {% if historial %}
        <div id="historial-container">
             <h4 class="text-black text-center mt-5">üïì {{ textos.historial }}</h4>
            <div class="d-flex flex-wrap gap-3 justify-content-center mt-3">
                {% for prod in historial %}
                    <div class="producto text-center p-3" style="width: 240px;">
                        <h6>{{ prod }}</h6>
                        <img src="{{ url_for('static', filename='images/' + nombre_a_imagen.get(prod, 'default.jpg')) }}"
                            class="img-fluid rounded"
                            onerror="this.onerror=null;this.src='/static/images/default.jpg';">
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}


    <!-- Mostrar alertas -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                <script>
                    alert("{{ message }}");
                </script>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <script>
        let choices;
    </script>

    <script>
        let synth = window.speechSynthesis;
        let leyendo = false;

        function leerFrases() {
            if (leyendo) {
                synth.cancel();
                leyendo = false;
                document.getElementById("btnLeer").innerText = "üîä {{ textos.leer }}";
                return;
            }

            const frases = [
                "{{ textos.titulo }}",
                "{{ textos.recomendaciones }}",
                "{{ recomendaciones | join(', ') }}",
                "{{ textos.historial }}",
                "{{ historial | join(', ') }}"
            ];

            leyendo = true;
            document.getElementById("btnLeer").innerText = "‚èπÔ∏è Detener";

            let index = 0;

            function leerSiguiente() {
                if (index < frases.length) {
                    const utterance = new SpeechSynthesisUtterance(frases[index]);
                    utterance.onend = () => {
                        index++;
                        leerSiguiente();
                    };
                    utterance.onerror = () => {
                        leyendo = false;
                        document.getElementById("btnLeer").innerText = "üîä {{ textos.leer }}";
                    };
                    synth.speak(utterance);
                } else {
                    leyendo = false;
                    document.getElementById("btnLeer").innerText = "üîä {{ textos.leer }}";
                }
            }

            leerSiguiente();
        }


        const saboresDisponibles = {
            es: ["dulce", "frutal", "caramelo", "chocolate", "floral", "lim√≥n", "vino", "suave", "intenso", "c√≠trico", "cremoso"],
            en: ["sweet", "fruity", "caramel", "chocolate", "floral", "lemon", "wine", "smooth", "intense", "citrus", "creamy"],
            br: ["doce", "frutal", "caramelo", "chocolate", "floral", "lim√£o", "vinho", "suave", "intenso", "c√≠trico", "cremoso"]
        };


        function reconocer() {
            if (!choices) return;

            const reconocimiento = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            reconocimiento.lang = "{{ 'es-ES' if lang == 'es' else 'en-US' if lang == 'en' else 'pt-BR' }}";
            reconocimiento.interimResults = true;

            reconocimiento.onresult = function(event) {
                const resultado = event.results[event.results.length - 1];

                if (!resultado.isFinal) return; 

                const texto = resultado[0].transcript.toLowerCase();
                console.log("Texto final:", texto);

                const sabores = {
                    es: ["dulce", "frutal", "caramelo", "chocolate", "floral", "lim√≥n", "vino", "suave", "intenso", "c√≠trico", "cremoso"],
                    en: ["sweet", "fruity", "caramel", "chocolate", "floral", "lemon", "wine", "smooth", "intense", "citrus", "creamy"],
                    br: ["doce", "frutal", "caramelo", "chocolate", "floral", "lim√£o", "vinho", "suave", "intenso", "c√≠trico", "cremoso"]
                };

                const lang = "{{ lang }}";

                choices.removeActiveItems();

                const encontrados = sabores[lang].filter(s => texto.includes(s));

                encontrados.slice(0, 3).forEach(sabor => {
                    choices.setChoiceByValue(sabor);
                });

                if (encontrados.length > 0) {
                    alert("Sabores detectados: " + encontrados.join(", "));
                } else {
                    alert("No se reconocieron sabores. Intenta decir: dulce, chocolate, frutal");
                }

                reconocimiento.stop();
            };

            reconocimiento.start();
        }
    </script>


    <script>
            document.addEventListener("DOMContentLoaded", function () {
                    const usuariosRegistrados = JSON.parse('{{ usuarios_csv | tojson | safe }}');
                    const formulario = document.getElementById("formulario");
                    const nombreInput = document.getElementById("nombre");
                    const perfilDiv = document.getElementById("perfil_sabor_group");
                    const perfilSelect = document.getElementById("perfil");
                    const recomendacionesDiv = document.getElementById("recomendaciones-container");
                    const historialDiv = document.getElementById("historial-container");
                    const saboresDiv = document.getElementById("sabores-container")

                    // Inicializar Choices.js
                    choices = new Choices(perfilSelect, {
                        removeItemButton: true,
                        maxItemCount: 3,
                        placeholder: true,
                        placeholderValue: '{{ textos.placeholderValue }}',
                        searchEnabled: false,
                        maxItemText: (maxItemCount) => {
                            return "{{ textos.maxSabores }}";
                        }
                    });

                    nombreInput.addEventListener("input", function () {
                        const nombre = nombreInput.value.trim().toLowerCase();
                        const esNuevo = !usuariosRegistrados.includes(nombre);
                        perfilDiv.style.display = esNuevo ? "block" : "none";
                    });
                    
                    // Borrar historial
                    nombreInput.addEventListener("focus", function () {
                        if (recomendacionesDiv) {
                            recomendacionesDiv.innerHTML = '';
                        }
                        if (historialDiv) {
                            historialDiv.innerHTML = '';
                        }
                        if (saboresDiv) {
                            saboresDiv.innerHTML = '';
                        }
                    });

                    formulario.addEventListener("submit", function (e) {
                        const nombre = nombreInput.value.trim().toLowerCase();
                        const perfilSeleccionado = choices.getValue(true);
                        const esNuevo = !usuariosRegistrados.includes(nombre);

                        if (esNuevo && perfilSeleccionado.length === 0) {
                            e.preventDefault();
                            alert("Por favor selecciona al menos un perfil de sabor.");
                        }
                    });

                    const mensajeMax = "{{ textos.maxSabores }}";
                    select.addEventListener("change", function () {
                        if (select.selectedOptions.length > 3) {
                            alert(mensajeMax);
                            select.options[select.selectedIndex].selected = false;
                        }
                    });
                });
    </script>

    <script>
        document.getElementById('lang-select').addEventListener('change', function () {
            const selectedLang = this.value;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('lang', selectedLang);
            window.location.href = currentUrl.toString();
        });
    </script>


    <script>
        let vozActivada = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let stream = null;
        let grabando = false;

        function toggleGrabacion() {
            const btn = document.getElementById("btnHablar");

            // Iniciar grabaci√≥n
            if (!grabando) {
                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(s => {
                        stream = s;
                        mediaRecorder = new MediaRecorder(stream);
                        audioChunks = [];

                        mediaRecorder.ondataavailable = e => audioChunks.push(e.data);

                        mediaRecorder.onstop = () => {
                            const audioBlob = new Blob(audioChunks, { type: "audio/webm" });
                            enviarAudio(audioBlob);

                            // Apagar micr√≥fono
                            stream.getTracks().forEach(t => t.stop());

                            btn.innerText = "üéôÔ∏è Hablar";
                            grabando = false;
                        };

                        mediaRecorder.start();

                        btn.innerText = "‚èπÔ∏è Detener";
                        grabando = true;
                    })
                    .catch(err => {
                        console.error("Error micr√≥fono:", err);
                    });
            }
            // Detener grabaci√≥n
            else {
                if (mediaRecorder && mediaRecorder.state === "recording") {
                    mediaRecorder.stop();
                }
            }
        }

        function toggleVoz() {
            const btn = document.getElementById("btnVoz");
            vozActivada = !vozActivada;

            if (vozActivada) {
                btn.innerText = "üîá Desactivar voz";
            } else {
                btn.innerText = "üîä Activar voz";
                speechSynthesis.cancel();
            }
        }

        function enviarAudio(blob) {
            const formData = new FormData();
            formData.append("audio", blob);

            fetch("/chat_audio", {
                method: "POST",
                body: formData
            })
            .then(res => res.json())
            .then(data => {
            agregarMensaje("Usuario", data.texto_usuario);
            agregarMensaje("Asistente", data.respuesta);

            if (vozActivada) {
                hablarRespuesta(data.respuesta);
            }
        });
        }

        function agregarMensaje(rol, texto) {
            const chat = document.getElementById("chatBox");
            chat.innerHTML += `<p><strong>${rol}:</strong> ${texto}</p>`;
            chat.scrollTop = chat.scrollHeight;
        }

        function hablarRespuesta(texto) {
            const utterance = new SpeechSynthesisUtterance(texto);
            utterance.lang = "{{ 'es-ES' if lang == 'es' else 'en-US' }}";
            speechSynthesis.speak(utterance);
        }
    </script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>


